---
import ogs from 'open-graph-scraper';
import CustomImage from "@/components/common/CustomImage.astro";

interface Props {
    url: string;
}

const { url } = Astro.props;

// OGP情報を取得する関数
async function fetchOGP(url: string) {
    try {
        const { result } = await ogs({ url });
        
        return {
            title: result.ogTitle || result.twitterTitle || url,
            description: result.ogDescription || result.twitterDescription || '',
            image: result.ogImage?.[0]?.url || result.twitterImage?.[0]?.url || '',
            siteName: result.ogSiteName || new URL(url).hostname,
        };
    } catch (error) {
        console.error('Failed to fetch OGP:', error);
        return {
            title: url,
            description: '',
            image: '',
            siteName: new URL(url).hostname,
        };
    }
}

const ogp = await fetchOGP(url);
console.log(`title: ${ogp.title}, image url: ${ogp.image}, type of image url: ${typeof ogp.image}`);
---

<a 
    href={url} 
    target="_blank" 
    rel="noopener noreferrer" 
    class="block no-underline border border-gray-200 rounded-lg overflow-hidden transition-shadow duration-200 hover:shadow-lg mb-4"
>
    <div class="flex flex-col gap-4 p-4 sm:flex-row">
        {ogp.image && (
            <div class="w-full aspect-[1.91/1] shrink-0 overflow-hidden rounded bg-gray-100 sm:w-40 sm:h-[84px] sm:order-2">
                <CustomImage 
                    src={ogp.image} 
                    alt={ogp.title} 
                    width={630} 
                    height={630}
                    class="w-full h-full object-cover" 
                />
            </div>
        )}
        <div class="flex-1 flex flex-col gap-2 min-w-0">
            <div class="text-base font-semibold leading-normal text-gray-800 overflow-hidden line-clamp-2">
                {ogp.title}
            </div>
            {ogp.description && (
                <div class="text-sm leading-normal text-gray-500 overflow-hidden line-clamp-2">
                    {ogp.description}
                </div>
            )}
            <div class="text-xs text-gray-400 mt-auto">
                {ogp.siteName}
            </div>
        </div>
    </div>
</a>